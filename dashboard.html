<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKT-RAG Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .okt-gradient { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%); }
        .card { backdrop-filter: blur(10px); background: rgba(255,255,255,0.95); }
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .file-item { transition: background 0.2s; }
        .file-item:hover { background: #f3f4f6; }
        .mode-btn { transition: all 0.2s; }
        .mode-btn.active { background: #667eea; color: white; }
        .mode-btn:not(.active):hover { background: #e5e7eb; }
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #667eea; color: #667eea; }
        .tab-btn:not(.active):hover { color: #667eea; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        /* Markdown Styling */
        .markdown-body h1 { font-size: 1.5rem; font-weight: 700; margin: 1rem 0 0.5rem; color: #1f2937; }
        .markdown-body h2 { font-size: 1.25rem; font-weight: 600; margin: 0.8rem 0 0.4rem; color: #374151; }
        .markdown-body h3 { font-size: 1.1rem; font-weight: 600; margin: 0.6rem 0 0.3rem; color: #4b5563; }
        .markdown-body p { margin: 0.5rem 0; line-height: 1.7; }
        .markdown-body ul, .markdown-body ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .markdown-body li { margin: 0.25rem 0; }
        .markdown-body code { background: #e5e7eb; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.875rem; }
        .markdown-body pre { background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 8px; overflow-x: auto; margin: 0.5rem 0; }
        .markdown-body pre code { background: transparent; padding: 0; }
        .markdown-body blockquote { border-left: 4px solid #667eea; padding-left: 1rem; margin: 0.5rem 0; color: #6b7280; }
        .markdown-body strong { font-weight: 600; color: #1f2937; }
        .markdown-body a { color: #667eea; text-decoration: underline; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; }
        .markdown-body th, .markdown-body td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
        .markdown-body th { background: #f9fafb; font-weight: 600; }
        /* Inline Citation Styling */
        .citation-marker {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.1rem 0.35rem;
            border-radius: 4px;
            margin: 0 0.1rem;
            vertical-align: super;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 1px 2px rgba(99, 102, 241, 0.3);
        }
        .citation-marker:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.4);
        }
        .source-card { transition: all 0.2s; }
        .source-card:hover { background: #f3f4f6; }
        .slot-card { transition: all 0.2s; }
        .slot-card:hover { transform: scale(1.02); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="okt-gradient text-white py-6 px-8 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="brain" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">OKT-RAG Dashboard</h1>
                    <p class="text-white/70 text-sm">Open Korea Tech RAG Platform - Model-Agnostic, Multi-Embedding, Observable</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="health-status" class="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full">
                    <span class="w-2 h-2 bg-green-400 rounded-full pulse"></span>
                    <span class="text-sm">Healthy</span>
                </div>
                <span id="version-badge" class="bg-white/20 px-3 py-1 rounded-full text-sm">v0.3.0</span>
                <button onclick="refreshAll()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Refresh
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-8 pt-6">
        <div class="flex gap-6 border-b border-gray-200">
            <button class="tab-btn active px-4 py-3 text-sm font-medium" data-tab="query">
                <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>Query
            </button>
            <button class="tab-btn px-4 py-3 text-sm font-medium" data-tab="embeddings">
                <i data-lucide="layers" class="w-4 h-4 inline mr-2"></i>Multi-Embedding
            </button>
            <button class="tab-btn px-4 py-3 text-sm font-medium" data-tab="analytics">
                <i data-lucide="bar-chart-3" class="w-4 h-4 inline mr-2"></i>Analytics
            </button>
            <button class="tab-btn px-4 py-3 text-sm font-medium" data-tab="files">
                <i data-lucide="files" class="w-4 h-4 inline mr-2"></i>Files
            </button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="stat-card card rounded-2xl p-5 shadow-lg border border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <span class="text-xs text-gray-400 uppercase">Files</span>
                </div>
                <div class="text-2xl font-bold text-gray-800" id="stat-files">-</div>
                <div class="text-xs text-gray-500">Indexed Files</div>
            </div>

            <div class="stat-card card rounded-2xl p-5 shadow-lg border border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i data-lucide="layers" class="w-5 h-5 text-purple-600"></i>
                    </div>
                    <span class="text-xs text-gray-400 uppercase">Slots</span>
                </div>
                <div class="text-2xl font-bold text-gray-800" id="stat-slots">-</div>
                <div class="text-xs text-gray-500">Embedding Slots</div>
            </div>

            <div class="stat-card card rounded-2xl p-5 shadow-lg border border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                        <i data-lucide="activity" class="w-5 h-5 text-green-600"></i>
                    </div>
                    <span class="text-xs text-gray-400 uppercase">Queries</span>
                </div>
                <div class="text-2xl font-bold text-gray-800" id="stat-queries">-</div>
                <div class="text-xs text-gray-500">Total Queries</div>
            </div>

            <div class="stat-card card rounded-2xl p-5 shadow-lg border border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                        <i data-lucide="zap" class="w-5 h-5 text-amber-600"></i>
                    </div>
                    <span class="text-xs text-gray-400 uppercase">Avg Time</span>
                </div>
                <div class="text-2xl font-bold text-gray-800" id="stat-avgtime">-</div>
                <div class="text-xs text-gray-500">ms / query</div>
            </div>

            <div class="stat-card card rounded-2xl p-5 shadow-lg border border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                        <i data-lucide="cpu" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="text-xs text-gray-400 uppercase">Model</span>
                </div>
                <div class="text-lg font-bold text-gray-800 truncate" id="stat-model">-</div>
                <div class="text-xs text-gray-500">LLM Model</div>
            </div>
        </div>

        <!-- Tab Content: Query -->
        <div id="tab-query" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Query Section -->
                <div class="lg:col-span-2">
                    <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100">
                            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                <i data-lucide="search" class="w-5 h-5 text-purple-600"></i>
                                RAG Query
                            </h2>
                        </div>
                        <div class="p-6">
                            <!-- Query Mode Selection -->
                            <div class="mb-4">
                                <label class="text-sm text-gray-600 mb-2 block">Query Mode</label>
                                <div class="flex gap-2 flex-wrap">
                                    <button class="mode-btn px-4 py-2 rounded-lg text-sm font-medium" data-mode="naive">Naive</button>
                                    <button class="mode-btn px-4 py-2 rounded-lg text-sm font-medium" data-mode="local">Local</button>
                                    <button class="mode-btn px-4 py-2 rounded-lg text-sm font-medium" data-mode="global">Global</button>
                                    <button class="mode-btn px-4 py-2 rounded-lg text-sm font-medium active" data-mode="hybrid">Hybrid</button>
                                    <button class="mode-btn px-4 py-2 rounded-lg text-sm font-medium bg-gradient-to-r from-purple-500 to-indigo-500 text-white" data-mode="adaptive">
                                        <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>Adaptive
                                    </button>
                                </div>
                            </div>

                            <!-- Embedding Slot Selection -->
                            <div class="mb-4">
                                <label class="text-sm text-gray-600 mb-2 block">Embedding Slot</label>
                                <select id="embedding-slot-select" class="px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="">Default (semantic)</option>
                                </select>
                            </div>

                            <!-- Auto-Verify Toggle -->
                            <div class="mb-4 flex items-center gap-3">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="auto-verify-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Auto-Verify Mode</span>
                                    <p class="text-xs text-gray-500">자동으로 인용을 검증하고 부정확한 인용은 제거합니다</p>
                                </div>
                            </div>

                            <!-- Query Input -->
                            <div class="relative mb-4">
                                <textarea
                                    id="query-input"
                                    class="w-full p-4 pr-12 border border-gray-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    rows="3"
                                    placeholder="질문을 입력하세요... (예: AI 인재 육성 방안은?)"
                                ></textarea>
                                <button
                                    onclick="submitQuery()"
                                    class="absolute right-3 bottom-3 w-10 h-10 bg-purple-600 hover:bg-purple-700 text-white rounded-lg flex items-center justify-center transition"
                                >
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <!-- Response Area -->
                            <div id="response-area" class="hidden">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                        <i data-lucide="message-square" class="w-4 h-4 text-purple-600"></i>
                                        Response
                                        <span id="verified-badge" class="hidden text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full flex items-center gap-1">
                                            <i data-lucide="shield-check" class="w-3 h-3"></i>
                                            Verified
                                        </span>
                                        <span id="adaptive-badge" class="hidden text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full flex items-center gap-1">
                                            <i data-lucide="sparkles" class="w-3 h-3"></i>
                                            <span id="adaptive-strategy">Adaptive</span>
                                        </span>
                                    </span>
                                    <span id="response-time" class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full"></span>
                                </div>

                                <!-- Removed Citations Notice -->
                                <div id="removed-citations-notice" class="hidden mb-3 bg-amber-50 border border-amber-200 rounded-lg p-3">
                                    <div class="flex items-center gap-2 text-amber-700">
                                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                                        <span class="text-sm font-medium">부정확한 인용이 자동으로 제거되었습니다</span>
                                    </div>
                                    <div id="removed-citations-list" class="text-xs text-amber-600 mt-1"></div>
                                </div>

                                <div id="response-content" class="markdown-body bg-gradient-to-br from-gray-50 to-white rounded-xl p-5 text-gray-700 leading-relaxed max-h-[600px] overflow-y-auto border border-gray-100 shadow-inner">
                                </div>

                                <!-- Sources Section -->
                                <div id="sources-area" class="hidden mt-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="book-open" class="w-4 h-4 text-blue-600"></i>
                                            <span class="text-sm font-medium text-gray-700">Sources</span>
                                            <span id="sources-count" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full"></span>
                                        </div>
                                        <button
                                            onclick="verifyCitations()"
                                            class="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-sm rounded-lg font-medium transition flex items-center gap-1.5"
                                        >
                                            <i data-lucide="shield-check" class="w-4 h-4"></i>
                                            Verify Citations
                                        </button>
                                    </div>
                                    <div id="sources-list" class="space-y-2">
                                    </div>
                                </div>

                                <!-- Verification Results Section -->
                                <div id="verification-area" class="hidden mt-4">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i data-lucide="shield-check" class="w-4 h-4 text-amber-600"></i>
                                        <span class="text-sm font-medium text-gray-700">Citation Verification</span>
                                        <span id="verify-accuracy" class="text-xs px-2 py-0.5 rounded-full"></span>
                                    </div>
                                    <div id="verification-summary" class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-4 mb-3 border border-amber-100">
                                    </div>
                                    <div id="verification-list" class="space-y-2 max-h-96 overflow-y-auto">
                                    </div>
                                </div>

                                <!-- Verification Loading -->
                                <div id="verify-loading" class="hidden mt-4">
                                    <div class="flex items-center justify-center py-4 bg-amber-50 rounded-lg">
                                        <div class="w-5 h-5 border-2 border-amber-200 border-t-amber-600 rounded-full animate-spin"></div>
                                        <span class="ml-2 text-amber-700 text-sm">Verifying citations...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Loading -->
                            <div id="loading-area" class="hidden">
                                <div class="flex items-center justify-center py-8">
                                    <div class="w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                                    <span class="ml-3 text-gray-500">Processing query...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Indexing Section -->
                    <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden mt-8">
                        <div class="p-6 border-b border-gray-100">
                            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                <i data-lucide="folder-sync" class="w-5 h-5 text-blue-600"></i>
                                Indexing
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="flex gap-4 mb-4">
                                <input
                                    type="text"
                                    id="index-path"
                                    class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value="./rag_raw_pdfs"
                                    placeholder="Path to index"
                                >
                                <button
                                    onclick="syncIndex()"
                                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition flex items-center gap-2"
                                >
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Sync
                                </button>
                                <button
                                    onclick="rebuildIndex()"
                                    class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium transition flex items-center gap-2"
                                    title="Clear and rebuild entire index"
                                >
                                    <i data-lucide="database" class="w-4 h-4"></i>
                                    Rebuild
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mb-3">
                                <strong>Sync:</strong> Index new/changed files only |
                                <strong>Rebuild:</strong> Clear all data and re-index everything
                            </p>
                            <div id="index-result" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4 text-blue-800">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div>
                    <!-- OKT-RAG Features -->
                    <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-6">
                        <div class="p-6 border-b border-gray-100">
                            <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-5 h-5 text-purple-600"></i>
                                OKT-RAG Features
                            </h2>
                        </div>
                        <div class="p-4 space-y-3">
                            <div id="feature-observability" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="activity" class="w-4 h-4 text-green-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-800">Observability</div>
                                    <div class="text-xs text-gray-500">Retrieval logging enabled</div>
                                </div>
                                <span class="ml-auto text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Active</span>
                            </div>
                            <div id="feature-multiembed" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="layers" class="w-4 h-4 text-purple-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-800">Multi-Embedding</div>
                                    <div class="text-xs text-gray-500" id="slot-count-text">2 slots configured</div>
                                </div>
                                <span class="ml-auto text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">Active</span>
                            </div>
                            <div id="feature-adaptive" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="wand-2" class="w-4 h-4 text-indigo-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-800">Adaptive Retrieval</div>
                                    <div class="text-xs text-gray-500">Auto strategy selection</div>
                                </div>
                                <span class="ml-auto text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">Active</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <i data-lucide="bar-chart-2" class="w-5 h-5 text-green-600"></i>
                                Quick Stats
                            </h2>
                            <button onclick="loadAnalytics()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="p-4 space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Avg Response Time</span>
                                <span class="text-sm font-semibold text-gray-800" id="quick-avgtime">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Cost (7d)</span>
                                <span class="text-sm font-semibold text-gray-800" id="quick-cost">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Citation Accuracy</span>
                                <span class="text-sm font-semibold text-gray-800" id="quick-accuracy">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Top Strategy</span>
                                <span class="text-sm font-semibold text-gray-800" id="quick-strategy">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Embeddings -->
        <div id="tab-embeddings" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Embedding Slots -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="layers" class="w-5 h-5 text-purple-600"></i>
                            Embedding Slots
                        </h2>
                    </div>
                    <div class="p-6" id="embedding-slots-container">
                        <div class="text-center text-gray-400 py-8">Loading...</div>
                    </div>
                </div>

                <!-- Matryoshka Support -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="box" class="w-5 h-5 text-indigo-600"></i>
                            Matryoshka Embeddings
                        </h2>
                    </div>
                    <div class="p-6" id="matryoshka-container">
                        <div class="text-center text-gray-400 py-8">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Architecture Diagram -->
            <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden mt-8">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="git-branch" class="w-5 h-5 text-indigo-600"></i>
                        OKT-RAG Architecture
                    </h2>
                </div>
                <div class="p-6">
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="text-center">
                                <div class="w-14 h-14 bg-white rounded-2xl shadow-md flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="file-text" class="w-7 h-7 text-blue-600"></i>
                                </div>
                                <div class="font-medium text-gray-700 text-sm">Documents</div>
                            </div>
                            <i data-lucide="arrow-right" class="w-5 h-5 text-gray-300 hidden md:block"></i>
                            <div class="text-center">
                                <div class="w-14 h-14 bg-white rounded-2xl shadow-md flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="layers" class="w-7 h-7 text-purple-600"></i>
                                </div>
                                <div class="font-medium text-gray-700 text-sm">Multi-Embedding</div>
                                <div class="text-xs text-gray-500">Slots</div>
                            </div>
                            <i data-lucide="arrow-right" class="w-5 h-5 text-gray-300 hidden md:block"></i>
                            <div class="text-center">
                                <div class="w-14 h-14 bg-white rounded-2xl shadow-md flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="wand-2" class="w-7 h-7 text-indigo-600"></i>
                                </div>
                                <div class="font-medium text-gray-700 text-sm">Adaptive</div>
                                <div class="text-xs text-gray-500">Retrieval</div>
                            </div>
                            <i data-lucide="arrow-right" class="w-5 h-5 text-gray-300 hidden md:block"></i>
                            <div class="text-center">
                                <div class="w-14 h-14 bg-white rounded-2xl shadow-md flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="sparkles" class="w-7 h-7 text-orange-600"></i>
                                </div>
                                <div class="font-medium text-gray-700 text-sm">LLM</div>
                                <div class="text-xs text-gray-500">Model-Agnostic</div>
                            </div>
                            <i data-lucide="arrow-right" class="w-5 h-5 text-gray-300 hidden md:block"></i>
                            <div class="text-center">
                                <div class="w-14 h-14 bg-white rounded-2xl shadow-md flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="activity" class="w-7 h-7 text-green-600"></i>
                                </div>
                                <div class="font-medium text-gray-700 text-sm">Observable</div>
                                <div class="text-xs text-gray-500">Logging</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Analytics -->
        <div id="tab-analytics" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Retrieval Stats -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>
                            Retrieval Statistics
                        </h2>
                    </div>
                    <div class="p-6" id="retrieval-stats-container">
                        <div class="text-center text-gray-400 py-8">Loading...</div>
                    </div>
                </div>

                <!-- Cost Analysis -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="dollar-sign" class="w-5 h-5 text-green-600"></i>
                            Cost Analysis
                        </h2>
                    </div>
                    <div class="p-6" id="cost-stats-container">
                        <div class="text-center text-gray-400 py-8">Loading...</div>
                    </div>
                </div>

                <!-- Strategy Distribution -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-5 h-5 text-purple-600"></i>
                            Strategy Distribution
                        </h2>
                    </div>
                    <div class="p-6">
                        <canvas id="strategy-chart" height="200"></canvas>
                    </div>
                </div>

                <!-- Slot Usage -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i>
                            Slot Usage
                        </h2>
                    </div>
                    <div class="p-6">
                        <canvas id="slot-chart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Second Row: Performance Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <!-- Slot Performance -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="gauge" class="w-5 h-5 text-orange-600"></i>
                            Slot Performance
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">응답 시간 및 비용 비교</p>
                    </div>
                    <div class="p-6">
                        <canvas id="slot-performance-chart" height="200"></canvas>
                        <div id="slot-performance-empty" class="hidden text-center text-gray-400 py-8">
                            <i data-lucide="bar-chart" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p>데이터가 없습니다. 쿼리를 실행해보세요.</p>
                        </div>
                    </div>
                </div>

                <!-- Strategy Performance -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="target" class="w-5 h-5 text-blue-600"></i>
                            Strategy Performance
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">검색 전략별 성능 비교</p>
                    </div>
                    <div class="p-6">
                        <canvas id="strategy-performance-chart" height="200"></canvas>
                        <div id="strategy-performance-empty" class="hidden text-center text-gray-400 py-8">
                            <i data-lucide="bar-chart" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p>데이터가 없습니다. 쿼리를 실행해보세요.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Third Row: Trends and Distribution -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <!-- Accuracy Trend -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="trending-up" class="w-5 h-5 text-green-600"></i>
                            Accuracy Trend
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">인용 정확도 추이</p>
                    </div>
                    <div class="p-6">
                        <canvas id="accuracy-trend-chart" height="200"></canvas>
                        <div id="accuracy-trend-empty" class="hidden text-center text-gray-400 py-8">
                            <i data-lucide="line-chart" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p>데이터가 없습니다. Auto-Verify 모드로 쿼리해보세요.</p>
                        </div>
                    </div>
                </div>

                <!-- Query Type Distribution -->
                <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-5 h-5 text-violet-600"></i>
                            Query Type Distribution
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">질문 유형별 분포</p>
                    </div>
                    <div class="p-6">
                        <canvas id="query-type-chart" height="200"></canvas>
                        <div id="query-type-empty" class="hidden text-center text-gray-400 py-8">
                            <i data-lucide="pie-chart" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p>데이터가 없습니다. Adaptive 모드로 쿼리해보세요.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Files -->
        <div id="tab-files" class="tab-content hidden">
            <div class="card rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="files" class="w-5 h-5 text-green-600"></i>
                        Indexed Files
                    </h2>
                    <button onclick="loadFiles()" class="text-gray-400 hover:text-gray-600 flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Refresh
                    </button>
                </div>
                <div class="max-h-[600px] overflow-y-auto">
                    <div id="files-list" class="divide-y divide-gray-100">
                    </div>
                    <div id="files-empty" class="hidden p-8 text-center text-gray-400">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p>No indexed files</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-400 text-sm">
        <p>OKT-RAG Dashboard v0.4.2 | Open Korea Tech RAG Platform</p>
    </footer>

    <script>
        const API_BASE = window.location.origin;
        let selectedMode = 'hybrid';
        let currentAnswer = '';
        let currentSources = [];
        let strategyChart = null;
        let slotChart = null;
        let slotPerformanceChart = null;
        let strategyPerformanceChart = null;
        let accuracyTrendChart = null;
        let queryTypeChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            refreshAll();

            // Tab handlers
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');

                    // Load tab-specific data
                    if (btn.dataset.tab === 'embeddings') loadEmbeddingConfig();
                    if (btn.dataset.tab === 'analytics') loadAnalytics();
                    if (btn.dataset.tab === 'files') loadFiles();
                });
            });

            // Mode button handlers
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('active');
                        if (b.dataset.mode !== 'adaptive') {
                            b.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-indigo-500', 'text-white');
                        }
                    });
                    btn.classList.add('active');
                    selectedMode = btn.dataset.mode;
                });
            });

            // Enter key for query
            document.getElementById('query-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitQuery();
                }
            });
        });

        async function refreshAll() {
            await Promise.all([
                loadStats(),
                loadFiles(),
                checkHealth(),
                loadEmbeddingSlots(),
                loadAnalytics()
            ]);
        }

        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                const statusEl = document.getElementById('health-status');
                if (data.status === 'healthy') {
                    statusEl.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full pulse"></span><span class="text-sm">Healthy</span>';
                } else {
                    statusEl.innerHTML = '<span class="w-2 h-2 bg-yellow-400 rounded-full pulse"></span><span class="text-sm">Degraded</span>';
                }
            } catch (e) {
                const statusEl = document.getElementById('health-status');
                statusEl.innerHTML = '<span class="w-2 h-2 bg-red-400 rounded-full"></span><span class="text-sm">Offline</span>';
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();

                document.getElementById('stat-files').textContent = data.tracked_files || 0;
                document.getElementById('stat-model').textContent = data.model_name || '-';
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function loadEmbeddingSlots() {
            try {
                const res = await fetch(`${API_BASE}/embedding/config`);
                const data = await res.json();

                document.getElementById('stat-slots').textContent = data.slots?.length || 0;
                document.getElementById('slot-count-text').textContent = `${data.slots?.length || 0} slots configured`;

                // Update embedding slot select
                const select = document.getElementById('embedding-slot-select');
                select.innerHTML = '<option value="">Default (' + (data.default_slot || 'semantic') + ')</option>';
                if (data.slots) {
                    data.slots.forEach(slot => {
                        select.innerHTML += `<option value="${slot.name}">${slot.name} (${slot.dimension}D)</option>`;
                    });
                }
            } catch (e) {
                console.error('Failed to load embedding config:', e);
            }
        }

        async function loadEmbeddingConfig() {
            try {
                const [configRes, matryoshkaRes] = await Promise.all([
                    fetch(`${API_BASE}/embedding/config`),
                    fetch(`${API_BASE}/embedding/matryoshka`)
                ]);

                const config = await configRes.json();
                const matryoshka = await matryoshkaRes.json();

                // Render slots
                const slotsContainer = document.getElementById('embedding-slots-container');
                if (config.slots && config.slots.length > 0) {
                    slotsContainer.innerHTML = config.slots.map(slot => `
                        <div class="slot-card bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 mb-4 border border-purple-100">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i data-lucide="box" class="w-5 h-5 text-purple-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-800">${slot.name}</div>
                                        <div class="text-xs text-gray-500">${slot.description || ''}</div>
                                    </div>
                                </div>
                                ${slot.enabled ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Enabled</span>' : '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">Disabled</span>'}
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-500 text-xs">Provider</div>
                                    <div class="font-medium">${slot.provider}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500 text-xs">Dimension</div>
                                    <div class="font-medium">${slot.dimension}D</div>
                                </div>
                                <div>
                                    <div class="text-gray-500 text-xs">Weight</div>
                                    <div class="font-medium">${slot.weight}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    slotsContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No embedding slots configured</div>';
                }

                // Render Matryoshka info
                const matryoshkaContainer = document.getElementById('matryoshka-container');
                if (matryoshka.supported_models) {
                    let html = '<div class="space-y-4">';
                    for (const [model, info] of Object.entries(matryoshka.supported_models)) {
                        html += `
                            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-4 border border-indigo-100">
                                <div class="font-semibold text-gray-800 mb-2">${model}</div>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${info.supported_dimensions.map(d => `
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${d === info.recommended_for_quality ? 'bg-green-100 text-green-700' : d === info.recommended_for_speed ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600'}">${d}D ${d === info.recommended_for_quality ? '(Quality)' : d === info.recommended_for_speed ? '(Speed)' : ''}</span>
                                    `).join('')}
                                </div>
                                <div class="text-xs text-gray-500">Default: ${info.default_dimension}D</div>
                            </div>
                        `;
                    }
                    html += '</div>';

                    if (matryoshka.benefits) {
                        html += '<div class="mt-6"><div class="text-sm font-medium text-gray-700 mb-2">Benefits:</div><ul class="text-sm text-gray-600 space-y-1">';
                        matryoshka.benefits.forEach(b => {
                            html += `<li class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500 mt-0.5"></i>${b}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    matryoshkaContainer.innerHTML = html;
                }

                lucide.createIcons();
            } catch (e) {
                console.error('Failed to load embedding config:', e);
            }
        }

        async function loadAnalytics() {
            try {
                const [retrievalRes, costRes] = await Promise.all([
                    fetch(`${API_BASE}/analytics/retrieval?days=7`),
                    fetch(`${API_BASE}/analytics/cost`)
                ]);

                const retrieval = await retrievalRes.json();
                const cost = await costRes.json();

                // Update stats
                document.getElementById('stat-queries').textContent = retrieval.total_queries || 0;
                document.getElementById('stat-avgtime').textContent = retrieval.avg_total_time_ms?.toFixed(0) || '-';
                document.getElementById('quick-avgtime').textContent = (retrieval.avg_total_time_ms?.toFixed(0) || '-') + ' ms';
                document.getElementById('quick-cost').textContent = '$' + (cost.total_cost_usd?.toFixed(4) || '0.0000');
                document.getElementById('quick-accuracy').textContent = retrieval.avg_citation_accuracy ? (retrieval.avg_citation_accuracy * 100).toFixed(0) + '%' : '-';

                // Find top strategy
                if (retrieval.search_strategy_distribution && Object.keys(retrieval.search_strategy_distribution).length > 0) {
                    const topStrategy = Object.entries(retrieval.search_strategy_distribution).sort((a, b) => b[1] - a[1])[0];
                    document.getElementById('quick-strategy').textContent = topStrategy[0];
                } else {
                    document.getElementById('quick-strategy').textContent = '-';
                }

                // Render retrieval stats
                const retrievalContainer = document.getElementById('retrieval-stats-container');
                retrievalContainer.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-blue-700">${retrieval.total_queries || 0}</div>
                            <div class="text-sm text-blue-600">Total Queries</div>
                        </div>
                        <div class="bg-green-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-green-700">${retrieval.avg_total_time_ms?.toFixed(0) || 0}</div>
                            <div class="text-sm text-green-600">Avg Time (ms)</div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-purple-700">${retrieval.avg_embedding_time_ms?.toFixed(0) || 0}</div>
                            <div class="text-sm text-purple-600">Embedding (ms)</div>
                        </div>
                        <div class="bg-amber-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-amber-700">${retrieval.avg_search_time_ms?.toFixed(0) || 0}</div>
                            <div class="text-sm text-amber-600">Search (ms)</div>
                        </div>
                    </div>
                    ${retrieval.date_range?.start ? `<div class="mt-4 text-xs text-gray-500 text-center">Period: ${retrieval.date_range.start} ~ ${retrieval.date_range.end}</div>` : ''}
                `;

                // Render cost stats
                const costContainer = document.getElementById('cost-stats-container');
                costContainer.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold text-green-700">$${cost.total_cost_usd?.toFixed(4) || '0.0000'}</div>
                            <div class="text-sm text-green-600">Total Cost</div>
                        </div>
                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold text-blue-700">$${cost.avg_cost_per_query_usd?.toFixed(6) || '0.000000'}</div>
                            <div class="text-sm text-blue-600">Per Query</div>
                        </div>
                    </div>
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Embedding Cost</span>
                            <span class="font-medium">$${cost.embedding_cost_usd?.toFixed(4) || '0.0000'} (${cost.cost_breakdown?.embedding_pct?.toFixed(0) || 0}%)</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">LLM Cost</span>
                            <span class="font-medium">$${cost.llm_cost_usd?.toFixed(4) || '0.0000'} (${cost.cost_breakdown?.llm_pct?.toFixed(0) || 0}%)</span>
                        </div>
                    </div>
                `;

                // Update charts
                updateStrategyChart(retrieval.search_strategy_distribution || {});
                updateSlotChart(retrieval.slot_usage || {});

                // Load additional analytics
                loadSlotPerformance();
                loadStrategyPerformance();
                loadAccuracyTrend();
                loadQueryTypeDistribution();

            } catch (e) {
                console.error('Failed to load analytics:', e);
            }
        }

        async function loadSlotPerformance() {
            try {
                const res = await fetch(`${API_BASE}/analytics/slots/performance`);
                const data = await res.json();

                const canvas = document.getElementById('slot-performance-chart');
                const emptyDiv = document.getElementById('slot-performance-empty');

                if (!data || data.length === 0) {
                    canvas.style.display = 'none';
                    emptyDiv.classList.remove('hidden');
                    return;
                }

                canvas.style.display = 'block';
                emptyDiv.classList.add('hidden');

                const ctx = canvas.getContext('2d');
                if (slotPerformanceChart) slotPerformanceChart.destroy();

                slotPerformanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.slot_name),
                        datasets: [
                            {
                                label: 'Avg Time (ms)',
                                data: data.map(d => d.avg_time_ms),
                                backgroundColor: '#6366f1',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Query Count',
                                data: data.map(d => d.query_count),
                                backgroundColor: '#10b981',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            y: { type: 'linear', position: 'left', title: { display: true, text: 'Time (ms)' } },
                            y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Count' } }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load slot performance:', e);
            }
        }

        async function loadStrategyPerformance() {
            try {
                const res = await fetch(`${API_BASE}/analytics/strategies/performance`);
                const data = await res.json();

                const canvas = document.getElementById('strategy-performance-chart');
                const emptyDiv = document.getElementById('strategy-performance-empty');

                if (!data || data.length === 0) {
                    canvas.style.display = 'none';
                    emptyDiv.classList.remove('hidden');
                    return;
                }

                canvas.style.display = 'block';
                emptyDiv.classList.add('hidden');

                const ctx = canvas.getContext('2d');
                if (strategyPerformanceChart) strategyPerformanceChart.destroy();

                strategyPerformanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.strategy),
                        datasets: [
                            {
                                label: 'Avg Time (ms)',
                                data: data.map(d => d.avg_time_ms),
                                backgroundColor: '#8b5cf6'
                            },
                            {
                                label: 'Accuracy (%)',
                                data: data.map(d => (d.avg_accuracy || 0) * 100),
                                backgroundColor: '#f59e0b'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load strategy performance:', e);
            }
        }

        async function loadAccuracyTrend() {
            try {
                const res = await fetch(`${API_BASE}/analytics/accuracy/trend?granularity=day`);
                const data = await res.json();

                const canvas = document.getElementById('accuracy-trend-chart');
                const emptyDiv = document.getElementById('accuracy-trend-empty');

                if (!data.data || data.data.length === 0) {
                    canvas.style.display = 'none';
                    emptyDiv.classList.remove('hidden');
                    return;
                }

                canvas.style.display = 'block';
                emptyDiv.classList.add('hidden');

                const ctx = canvas.getContext('2d');
                if (accuracyTrendChart) accuracyTrendChart.destroy();

                accuracyTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(d => d.timestamp),
                        datasets: [{
                            label: 'Citation Accuracy (%)',
                            data: data.data.map(d => (d.accuracy || 0) * 100),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Accuracy (%)' } }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load accuracy trend:', e);
            }
        }

        async function loadQueryTypeDistribution() {
            try {
                const res = await fetch(`${API_BASE}/analytics/query-types`);
                const data = await res.json();

                const canvas = document.getElementById('query-type-chart');
                const emptyDiv = document.getElementById('query-type-empty');

                if (!data.distribution || Object.keys(data.distribution).length === 0) {
                    canvas.style.display = 'none';
                    emptyDiv.classList.remove('hidden');
                    return;
                }

                canvas.style.display = 'block';
                emptyDiv.classList.add('hidden');

                const ctx = canvas.getContext('2d');
                if (queryTypeChart) queryTypeChart.destroy();

                const labels = Object.keys(data.distribution);
                const values = Object.values(data.distribution);
                const colors = {
                    'factual': '#3b82f6',
                    'analytical': '#8b5cf6',
                    'comparative': '#f59e0b',
                    'procedural': '#10b981',
                    'unknown': '#6b7280'
                };

                queryTypeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                        datasets: [{
                            data: values,
                            backgroundColor: labels.map(l => colors[l] || '#6b7280'),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: `Total: ${data.total} queries` }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load query type distribution:', e);
            }
        }

        function updateStrategyChart(data) {
            const ctx = document.getElementById('strategy-chart').getContext('2d');

            if (strategyChart) strategyChart.destroy();

            const labels = Object.keys(data);
            const values = Object.values(data);

            if (labels.length === 0) {
                ctx.canvas.parentElement.innerHTML = '<div class="text-center text-gray-400 py-8">No strategy data yet</div>';
                return;
            }

            strategyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function updateSlotChart(data) {
            const ctx = document.getElementById('slot-chart').getContext('2d');

            if (slotChart) slotChart.destroy();

            const labels = Object.keys(data);
            const values = Object.values(data);

            if (labels.length === 0) {
                ctx.canvas.parentElement.innerHTML = '<div class="text-center text-gray-400 py-8">No slot usage data yet</div>';
                return;
            }

            slotChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Queries',
                        data: values,
                        backgroundColor: '#6366f1',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function loadFiles() {
            try {
                const res = await fetch(`${API_BASE}/index/files`);
                const data = await res.json();

                const listEl = document.getElementById('files-list');
                const emptyEl = document.getElementById('files-empty');

                if (data.files.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.classList.remove('hidden');
                    return;
                }

                emptyEl.classList.add('hidden');
                listEl.innerHTML = data.files.map(file => `
                    <div class="file-item p-4 flex items-center gap-4">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i data-lucide="file-text" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 truncate" title="${file.file_name}">${file.file_name}</div>
                            <div class="text-sm text-gray-400">${formatBytes(file.file_size)} • ${formatDate(file.indexed_at)}</div>
                        </div>
                        <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                        </div>
                    </div>
                `).join('');

                lucide.createIcons();
            } catch (e) {
                console.error('Failed to load files:', e);
            }
        }

        async function submitQuery() {
            const input = document.getElementById('query-input');
            const question = input.value.trim();
            const autoVerify = document.getElementById('auto-verify-toggle').checked;
            const embeddingSlot = document.getElementById('embedding-slot-select').value;

            if (!question) return;

            const responseArea = document.getElementById('response-area');
            const loadingArea = document.getElementById('loading-area');
            const responseContent = document.getElementById('response-content');
            const responseTime = document.getElementById('response-time');
            const sourcesArea = document.getElementById('sources-area');
            const sourcesList = document.getElementById('sources-list');
            const sourcesCount = document.getElementById('sources-count');
            const verifiedBadge = document.getElementById('verified-badge');
            const adaptiveBadge = document.getElementById('adaptive-badge');
            const removedCitationsNotice = document.getElementById('removed-citations-notice');
            const removedCitationsList = document.getElementById('removed-citations-list');

            responseArea.classList.add('hidden');
            sourcesArea.classList.add('hidden');
            loadingArea.classList.remove('hidden');
            verifiedBadge.classList.add('hidden');
            adaptiveBadge.classList.add('hidden');
            removedCitationsNotice.classList.add('hidden');
            document.getElementById('verification-area').classList.add('hidden');

            try {
                let data;
                const requestBody = {
                    question,
                    mode: selectedMode,
                    embedding_slot: embeddingSlot || undefined
                };

                if (autoVerify) {
                    requestBody.confidence_threshold = 0.7;
                    const res = await fetch(`${API_BASE}/query/verified`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    data = await res.json();

                    currentAnswer = data.corrected_answer;
                    currentSources = data.sources || [];

                    loadingArea.classList.add('hidden');
                    responseArea.classList.remove('hidden');

                    verifiedBadge.classList.remove('hidden');

                    if (data.removed_citations && data.removed_citations.length > 0) {
                        removedCitationsNotice.classList.remove('hidden');
                        removedCitationsList.textContent = `제거된 인용: [${data.removed_citations.join('], [')}]`;
                    }

                    responseContent.innerHTML = marked.parse(data.corrected_answer);
                    styleCitationMarkers(responseContent);

                    let timeText = `${data.processing_time_ms.toFixed(0)}ms • ${data.mode} mode • ${(data.accuracy_rate * 100).toFixed(0)}% accuracy`;
                    if (data.metadata?.detected_query_type) {
                        adaptiveBadge.classList.remove('hidden');
                        document.getElementById('adaptive-strategy').textContent = data.metadata.detected_query_type;
                    }
                    responseTime.textContent = timeText;

                    // Filter sources to only show those that weren't removed
                    const filteredSources = data.sources.filter((_, idx) =>
                        !data.removed_citations.includes(idx + 1)
                    );
                    displaySources(filteredSources, sourcesArea, sourcesList, sourcesCount, data.removed_citations);
                    displayVerificationLog(data.verification_log, data.accuracy_rate, data.processing_time_ms);

                } else {
                    const res = await fetch(`${API_BASE}/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    data = await res.json();

                    currentAnswer = data.answer;
                    currentSources = data.sources || [];

                    loadingArea.classList.add('hidden');
                    responseArea.classList.remove('hidden');

                    responseContent.innerHTML = marked.parse(data.answer);
                    styleCitationMarkers(responseContent);

                    let timeText = `${data.processing_time_ms.toFixed(0)}ms • ${data.mode} mode`;
                    if (data.metadata?.detected_query_type) {
                        adaptiveBadge.classList.remove('hidden');
                        document.getElementById('adaptive-strategy').textContent = data.metadata.detected_query_type;
                        timeText += ` • ${data.metadata.strategy_used}`;
                    }
                    responseTime.textContent = timeText;

                    displaySources(data.sources, sourcesArea, sourcesList, sourcesCount);
                }

                // Refresh analytics after query
                loadAnalytics();

            } catch (e) {
                loadingArea.classList.add('hidden');
                responseArea.classList.remove('hidden');
                responseContent.innerHTML = '<p class="text-red-600">Error: Failed to get response. Please check if the server is running.</p>';
                responseTime.textContent = '';
                sourcesArea.classList.add('hidden');
            }
        }

        // Style inline citation markers [†1], [†2] etc.
        function styleCitationMarkers(element) {
            const html = element.innerHTML;
            // Match [†1], [†2], [1], [2] patterns
            const styledHtml = html.replace(
                /\[†?(\d+)\]/g,
                '<span class="citation-marker" onclick="scrollToSource($1)" title="소스 $1로 이동">†$1</span>'
            );
            element.innerHTML = styledHtml;
        }

        // Scroll to source card when citation is clicked
        function scrollToSource(num) {
            const sourceCards = document.querySelectorAll('.source-card');
            if (sourceCards.length >= num) {
                sourceCards[num - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                sourceCards[num - 1].classList.add('ring-2', 'ring-indigo-400');
                setTimeout(() => {
                    sourceCards[num - 1].classList.remove('ring-2', 'ring-indigo-400');
                }, 2000);
            }
        }

        function displaySources(sources, sourcesArea, sourcesList, sourcesCount) {
            if (sources && sources.length > 0) {
                sourcesArea.classList.remove('hidden');
                sourcesCount.textContent = `${sources.length}`;
                sourcesList.innerHTML = sources.map((source, idx) => `
                    <div class="source-card bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-blue-700 font-semibold text-sm">†${idx + 1}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 flex-wrap mb-1">
                                    <span class="font-medium text-gray-800 text-sm truncate" title="${source.file_name || 'Unknown'}">
                                        <i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>
                                        ${source.file_name || 'Unknown'}
                                    </span>
                                    ${source.page ? `
                                        <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">
                                            Page ${source.page}
                                        </span>
                                    ` : ''}
                                    ${source.relevance_score ? `
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">
                                            ${(source.relevance_score * 100).toFixed(0)}% match
                                        </span>
                                    ` : ''}
                                </div>
                                ${source.excerpt ? `
                                    <div class="text-sm text-gray-600 leading-relaxed bg-white rounded p-2 border-l-2 border-purple-300">
                                        <i data-lucide="quote" class="w-3 h-3 inline text-purple-400 mr-1"></i>
                                        "${source.excerpt.substring(0, 200)}${source.excerpt.length > 200 ? '...' : ''}"
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } else {
                sourcesArea.classList.add('hidden');
            }
        }

        function displayVerificationLog(verificationLog, accuracyRate, processingTime) {
            const verificationArea = document.getElementById('verification-area');
            const verificationSummary = document.getElementById('verification-summary');
            const verificationList = document.getElementById('verification-list');
            const verifyAccuracy = document.getElementById('verify-accuracy');

            if (!verificationLog || verificationLog.length === 0) {
                verificationArea.classList.add('hidden');
                return;
            }

            verificationArea.classList.remove('hidden');

            const accurateCount = verificationLog.filter(v => v.status === '✅ 정확').length;
            const inaccurateCount = verificationLog.filter(v => v.status === '❌ 부정확').length;
            const uncertainCount = verificationLog.filter(v => v.status === '⚠️ 불확실').length;
            const totalCount = verificationLog.length;

            const accuracyPct = (accuracyRate * 100).toFixed(0);
            let accuracyClass = 'bg-green-100 text-green-700';
            if (accuracyRate < 0.7) accuracyClass = 'bg-red-100 text-red-700';
            else if (accuracyRate < 0.9) accuracyClass = 'bg-yellow-100 text-yellow-700';
            verifyAccuracy.className = `text-xs px-2 py-0.5 rounded-full ${accuracyClass}`;
            verifyAccuracy.textContent = `${accuracyPct}% Accurate`;

            verificationSummary.innerHTML = `
                <div class="grid grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-gray-800">${totalCount}</div>
                        <div class="text-xs text-gray-500">Total</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-600">${accurateCount}</div>
                        <div class="text-xs text-gray-500">Accurate</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-red-600">${inaccurateCount}</div>
                        <div class="text-xs text-gray-500">Inaccurate</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-yellow-600">${uncertainCount}</div>
                        <div class="text-xs text-gray-500">Uncertain</div>
                    </div>
                </div>
            `;

            verificationList.innerHTML = verificationLog.map(v => {
                let statusIcon, statusClass, bgClass;
                if (v.status === '⚠️ 불확실') {
                    statusIcon = 'help-circle';
                    statusClass = 'text-yellow-600';
                    bgClass = 'bg-yellow-50 border-yellow-200';
                } else if (v.status === '✅ 정확') {
                    statusIcon = 'check-circle';
                    statusClass = 'text-green-600';
                    bgClass = 'bg-green-50 border-green-200';
                } else {
                    statusIcon = 'x-circle';
                    statusClass = 'text-red-600';
                    bgClass = 'bg-red-50 border-red-200';
                }

                return `
                    <div class="rounded-lg p-3 border ${bgClass}">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 mt-0.5">
                                <i data-lucide="${statusIcon}" class="w-5 h-5 ${statusClass}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full font-medium">[†${v.citation_number}]</span>
                                    <span class="text-xs text-gray-500">${v.source_file || 'Unknown'}${v.source_page ? `, p.${v.source_page}` : ''}</span>
                                    <span class="text-xs text-gray-400">(${(v.confidence * 100).toFixed(0)}% confidence)</span>
                                </div>
                                <div class="text-sm text-gray-700 mb-2">
                                    <strong>Statement:</strong> ${v.statement}
                                </div>
                                <div class="text-sm ${statusClass} font-medium">
                                    ${v.explanation}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        async function syncIndex() {
            const path = document.getElementById('index-path').value;
            const resultEl = document.getElementById('index-result');

            resultEl.classList.remove('hidden');
            resultEl.className = 'bg-blue-50 border border-blue-200 rounded-xl p-4 text-blue-800';
            resultEl.innerHTML = '<div class="flex items-center gap-2"><div class="w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div> Syncing...</div>';

            try {
                const res = await fetch(`${API_BASE}/index/local/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path, recursive: true })
                });

                const data = await res.json();

                if (data.success) {
                    resultEl.className = 'bg-green-50 border border-green-200 rounded-xl p-4 text-green-800';
                    resultEl.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> ${data.message}</div>`;
                    await refreshAll();
                } else {
                    resultEl.className = 'bg-red-50 border border-red-200 rounded-xl p-4 text-red-800';
                    resultEl.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="x-circle" class="w-5 h-5"></i> Failed: ${data.message}</div>`;
                }
                lucide.createIcons();
            } catch (e) {
                resultEl.className = 'bg-red-50 border border-red-200 rounded-xl p-4 text-red-800';
                resultEl.innerHTML = '<div class="flex items-center gap-2"><i data-lucide="x-circle" class="w-5 h-5"></i> Error: Server connection failed</div>';
                lucide.createIcons();
            }
        }

        async function rebuildIndex() {
            if (!confirm('This will clear ALL indexed data and rebuild from scratch. Continue?')) {
                return;
            }

            const path = document.getElementById('index-path').value;
            const resultEl = document.getElementById('index-result');

            resultEl.classList.remove('hidden');
            resultEl.className = 'bg-orange-50 border border-orange-200 rounded-xl p-4 text-orange-800';
            resultEl.innerHTML = '<div class="flex items-center gap-2"><div class="w-4 h-4 border-2 border-orange-400 border-t-transparent rounded-full animate-spin"></div> Rebuilding index (this may take a while)...</div>';

            try {
                const res = await fetch(`${API_BASE}/index/rebuild`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path, recursive: true })
                });

                const data = await res.json();

                if (data.success) {
                    resultEl.className = 'bg-green-50 border border-green-200 rounded-xl p-4 text-green-800';
                    resultEl.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> ${data.message}</div>`;
                    await refreshAll();
                } else {
                    resultEl.className = 'bg-red-50 border border-red-200 rounded-xl p-4 text-red-800';
                    resultEl.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="x-circle" class="w-5 h-5"></i> Failed: ${data.detail || data.message}</div>`;
                }
                lucide.createIcons();
            } catch (e) {
                resultEl.className = 'bg-red-50 border border-red-200 rounded-xl p-4 text-red-800';
                resultEl.innerHTML = '<div class="flex items-center gap-2"><i data-lucide="x-circle" class="w-5 h-5"></i> Error: Server connection failed or timeout</div>';
                lucide.createIcons();
            }
        }

        async function verifyCitations() {
            if (!currentAnswer || currentSources.length === 0) {
                alert('No response to verify. Please submit a query first.');
                return;
            }

            const verifyLoading = document.getElementById('verify-loading');
            const verificationArea = document.getElementById('verification-area');
            const verificationSummary = document.getElementById('verification-summary');
            const verificationList = document.getElementById('verification-list');
            const verifyAccuracy = document.getElementById('verify-accuracy');

            verifyLoading.classList.remove('hidden');
            verificationArea.classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/query/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        answer: currentAnswer,
                        sources: currentSources
                    })
                });

                const data = await res.json();

                verifyLoading.classList.add('hidden');
                verificationArea.classList.remove('hidden');

                const accuracyPct = (data.accuracy_rate * 100).toFixed(0);
                let accuracyClass = 'bg-green-100 text-green-700';
                if (data.accuracy_rate < 0.7) accuracyClass = 'bg-red-100 text-red-700';
                else if (data.accuracy_rate < 0.9) accuracyClass = 'bg-yellow-100 text-yellow-700';
                verifyAccuracy.className = `text-xs px-2 py-0.5 rounded-full ${accuracyClass}`;
                verifyAccuracy.textContent = `${accuracyPct}% Accurate`;

                verificationSummary.innerHTML = `
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-gray-800">${data.total_citations}</div>
                            <div class="text-xs text-gray-500">Total</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-600">${data.accurate_count}</div>
                            <div class="text-xs text-gray-500">Accurate</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-600">${data.inaccurate_count}</div>
                            <div class="text-xs text-gray-500">Inaccurate</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-yellow-600">${data.uncertain_count}</div>
                            <div class="text-xs text-gray-500">Uncertain</div>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 text-center">
                        Processed in ${data.processing_time_ms.toFixed(0)}ms
                    </div>
                `;

                verificationList.innerHTML = data.verifications.map(v => {
                    let statusIcon, statusClass, bgClass;
                    if (v.confidence < 0.5) {
                        statusIcon = 'help-circle';
                        statusClass = 'text-yellow-600';
                        bgClass = 'bg-yellow-50 border-yellow-200';
                    } else if (v.is_accurate) {
                        statusIcon = 'check-circle';
                        statusClass = 'text-green-600';
                        bgClass = 'bg-green-50 border-green-200';
                    } else {
                        statusIcon = 'x-circle';
                        statusClass = 'text-red-600';
                        bgClass = 'bg-red-50 border-red-200';
                    }

                    return `
                        <div class="rounded-lg p-3 border ${bgClass}">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 mt-0.5">
                                    <i data-lucide="${statusIcon}" class="w-5 h-5 ${statusClass}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full font-medium">[†${v.citation_number}]</span>
                                        <span class="text-xs text-gray-500">${v.source_file}${v.source_page ? `, p.${v.source_page}` : ''}</span>
                                        <span class="text-xs text-gray-400">(${(v.confidence * 100).toFixed(0)}% confidence)</span>
                                    </div>
                                    <div class="text-sm text-gray-700 mb-2">
                                        <strong>Statement:</strong> ${v.statement}
                                    </div>
                                    <div class="text-sm ${statusClass} font-medium">
                                        ${v.explanation}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                lucide.createIcons();

            } catch (e) {
                verifyLoading.classList.add('hidden');
                verificationArea.classList.remove('hidden');
                verificationSummary.innerHTML = `
                    <div class="text-red-600 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                        Verification failed: ${e.message}
                    </div>
                `;
                verificationList.innerHTML = '';
                lucide.createIcons();
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>
